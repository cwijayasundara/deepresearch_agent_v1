#!/usr/bin/env python3
"""Project scaffolding script for /forge:init.

Copies the full .claude/ directory (agents, commands, skills, hooks,
linters, scripts, templates, docs, settings) into the target project,
then creates the 6-layer backend/ structure, tests, specs, and config files.

After scaffolding, users run `claude` without --plugin-dir — everything
is local.

Usage: python3 scaffold_project.py [project-type] [project-root]
  project-type: python-fastapi (default), python-cli, node-express
  project-root: directory to scaffold (default: current directory)
"""
import json
import shutil
import sys
from pathlib import Path

SCRIPT_DIR = Path(__file__).resolve().parent
PLUGIN_ROOT = SCRIPT_DIR.parent

SRC_LAYERS = ["types", "config", "repo", "service", "runtime", "ui"]
TEST_LAYERS = SRC_LAYERS + ["e2e"]
SPEC_DIRS = ["features", "stories", "design", "tests", "plans"]

# Directories/files to copy from the plugin into .claude/
PLUGIN_DIRS_TO_COPY = [
    "agents",
    "commands",
    "docs",
    "evals",
    "hooks",
    "linters",
    "scripts",
    "skills",
    "templates",
]
PLUGIN_FILES_TO_COPY = [
    "settings.json",
]
# These are plugin-only or user-specific — do NOT copy
PLUGIN_SKIP = [
    ".claude-plugin",
    ".mcp.json",
    "settings.local.json",
]


def create_directory(path: Path) -> None:
    """Create directory if it doesn't exist."""
    path.mkdir(parents=True, exist_ok=True)


def write_file(path: Path, content: str) -> None:
    """Write file only if it doesn't already exist."""
    if path.exists():
        print(f"  skip (exists): {path}")
        return
    path.parent.mkdir(parents=True, exist_ok=True)
    path.write_text(content)
    print(f"  created: {path}")


def copy_plugin_directory(root: Path) -> None:
    """Copy the full .claude/ directory from the plugin into the project.

    Copies agents, commands, skills, hooks, linters, scripts, templates,
    docs, evals, and settings.json. Rewrites hook script paths from
    ${CLAUDE_PLUGIN_ROOT} to relative .claude paths.
    """
    target_claude = root / ".claude"
    create_directory(target_claude)

    # Copy directories
    for dirname in PLUGIN_DIRS_TO_COPY:
        src = PLUGIN_ROOT / dirname
        dest = target_claude / dirname
        if not src.is_dir():
            continue
        if dest.exists():
            print(f"  skip (exists): {dest}")
            continue
        shutil.copytree(src, dest)
        print(f"  copied: {dest}")

    # Copy individual files
    for filename in PLUGIN_FILES_TO_COPY:
        src = PLUGIN_ROOT / filename
        dest = target_claude / filename
        if not src.is_file():
            continue
        if dest.exists():
            print(f"  skip (exists): {dest}")
            continue
        shutil.copy2(src, dest)
        print(f"  copied: {dest}")

    # Rewrite hook paths: ${CLAUDE_PLUGIN_ROOT}/... -> .claude/...
    hooks_file = target_claude / "hooks" / "hooks.json"
    if hooks_file.is_file():
        content = hooks_file.read_text()
        rewritten = content.replace(
            "${CLAUDE_PLUGIN_ROOT}/", ".claude/"
        )
        if rewritten != content:
            hooks_file.write_text(rewritten)
            print(f"  rewritten hook paths: {hooks_file}")


def create_src_structure(root: Path) -> None:
    """Create backend/ with layer directories."""
    for layer in SRC_LAYERS:
        layer_dir = root / "src" / layer
        create_directory(layer_dir)
        write_file(layer_dir / "__init__.py", "")


def create_test_structure(root: Path) -> None:
    """Create tests/ with matching layer directories."""
    for layer in TEST_LAYERS:
        layer_dir = root / "tests" / layer
        create_directory(layer_dir)
        write_file(layer_dir / "__init__.py", "")
        write_file(
            layer_dir / "conftest.py",
            f'"""Fixtures for {layer} tests."""\n',
        )


def create_spec_structure(root: Path) -> None:
    """Create specs/ directories with .gitkeep."""
    for subdir in SPEC_DIRS:
        spec_dir = root / "specs" / subdir
        create_directory(spec_dir)
        write_file(spec_dir / ".gitkeep", "")


def generate_claude_md(root: Path, project_type: str) -> None:
    """Generate CLAUDE.md with full forge instructions."""
    content = f"""\
# Project Configuration

> Generated by claude-code-forge for {project_type}

## Request Routing (CRITICAL)

Before writing any code, classify the user's request:

| Pattern | Category | Action |
|---------|----------|--------|
| "Build me X", "Create a", "Add feature X", "New app" | **Pipeline** | Invoke `/build` — do NOT explore or plan first |
| "Just do it", "Quick change", "Skip the spec" | **Quick Build** | Invoke `/just-do-it` — TDD without spec ceremony |
| "Continue", "Resume", "What's next" | **Resume** | Read `specs/pipeline_status.md`, resume from next incomplete phase |
| Everything else (bug fixes, refactoring, questions) | **Toolbox** | Handle directly; slash commands available |

**Never skip the spec-writer for "build" or "add feature" requests.**

## Architecture: 6-Layer Model

```
Types(0) -> Config(1) -> Repo(2) -> Service(3) -> Runtime(4) -> UI(5)
```

Code may only depend **forward** through layers. Backward imports are forbidden and enforced by `.claude/linters/layer_deps.py`.

| Layer | Path | May Import From | Never Import From |
|-------|------|-----------------|-------------------|
| Types | `backend/types/` | (none) | All others |
| Config | `backend/config/` | Types | Repo, Service, Runtime, UI |
| Repo | `backend/repo/` | Types, Config | Service, Runtime, UI |
| Service | `backend/service/` | Types, Config, Repo | Runtime, UI |
| Runtime | `backend/runtime/` | Types, Config, Repo, Service | UI |
| UI | `backend/ui/` | All layers | (none) |

## TDD Enforcement (Iron Law)

Every acceptance criterion follows the TDD cycle:

1. **RED** — Write a failing test that asserts the expected behavior
2. **GREEN** — Write the minimum production code to pass
3. **REFACTOR** — Clean up without changing behavior

Never write production code without a failing test first.

## Quality Gates

- **Linters**: `python3 .claude/linters/lint_all.py` (layer deps + file size)
- **Tests**: `pytest tests/ --cov=src --cov-fail-under=80`
- **File limits**: 300 lines per file, 50 lines per function

## Conventions

- **Files**: `snake_case.py` | **Classes**: `PascalCase` | **Constants**: `UPPER_SNAKE_CASE`
- **Logging**: `logging.getLogger(__name__)` — never `print()`
- **Error handling**: catch specific exceptions in Repo layer, log with context
- **Type hints**: all function signatures, no `Any`
- **Imports**: stdlib -> third-party -> project (in layer order)
- **Git**: feature branches `feature/<story-id>-<brief-name>`, one commit per story
"""
    write_file(root / "CLAUDE.md", content)


def generate_pyproject(root: Path) -> None:
    """Generate pyproject.toml."""
    name = root.name.replace(" ", "-").lower()
    content = f"""\
[project]
name = "{name}"
version = "0.1.0"
requires-python = ">=3.11"
dependencies = []

[project.optional-dependencies]
dev = [
    "pytest>=7.0",
    "pytest-cov>=4.0",
    "pytest-asyncio>=0.21",
    "ruff>=0.1.0",
]

[tool.pytest.ini_options]
testpaths = ["tests"]
asyncio_mode = "auto"

[tool.ruff]
line-length = 88
target-version = "py311"

[tool.ruff.lint]
select = ["E", "F", "I", "N", "W"]
"""
    write_file(root / "pyproject.toml", content)


def generate_makefile(root: Path) -> None:
    """Generate Makefile."""
    content = """\
.PHONY: test lint fmt check

test:
\tpython -m pytest tests/ -v --tb=short

lint:
\tpython -m ruff check backend/ tests/
\tpython3 .claude/linters/layer_deps.py backend/
\tpython3 .claude/linters/file_size.py backend/

fmt:
\tpython -m ruff format backend/ tests/

check: lint test
"""
    write_file(root / "Makefile", content)


def generate_env_example(root: Path) -> None:
    """Generate .env.example."""
    content = """\
# Application
APP_ENV=development
APP_DEBUG=true
APP_PORT=8000

# Database
DATABASE_URL=sqlite:///./dev.db

# Secrets (never commit actual values)
SECRET_KEY=change-me-in-production
"""
    write_file(root / ".env.example", content)


def generate_readme(root: Path, project_type: str) -> None:
    """Generate README.md for the scaffolded project."""
    name = root.name.replace("_", " ").replace("-", " ").title()
    content = f"""\
# {name}

> Built with [claude-code-forge](https://github.com/cwijayasundara/claude_code_forge_v1) — a Claude Code plugin for spec-driven development.

## Getting Started

### Prerequisites

- Python 3.11+
- [Claude Code CLI](https://docs.anthropic.com/en/docs/claude-code)

### Setup

```bash
python -m venv .venv
source .venv/bin/activate
pip install -e ".[dev]"
```

### Development

```bash
make test    # Run tests
make lint    # Run linters (layer deps + file size)
make fmt     # Format code
make check   # Lint + test
```

## Architecture

This project uses a strict 6-layer architecture with forward-only dependencies:

```
Types(0) -> Config(1) -> Repo(2) -> Service(3) -> Runtime(4) -> UI(5)
```

| Layer | Path | Description |
|-------|------|-------------|
| Types | `backend/types/` | Domain types (Pydantic models, no project imports) |
| Config | `backend/config/` | Configuration loading |
| Repo | `backend/repo/` | Data access (DB, HTTP, filesystem) |
| Service | `backend/service/` | Business logic (no direct I/O) |
| Runtime | `backend/runtime/` | App startup, dependency wiring |
| UI | `backend/ui/` | API routes, CLI handlers |

## Forge Commands

This project includes the full claude-code-forge toolkit. Just run `claude` in this directory — no `--plugin-dir` needed.

| Command | Description |
|---------|-------------|
| `/build` | Full 11-phase SDLC pipeline |
| `/add-feature` | Add a feature to this project |
| `/just-do-it` | Quick build without spec ceremony |
| `/resume` | Resume an interrupted pipeline |
| `/debug` | 5-phase debugging workflow |
| `/review` | 8-agent parallel code review |
| `/validate` | Full verification suite |
| `/help` | Show all commands |

## Project Structure

```
.claude/             # Forge agents, commands, skills, hooks, linters
backend/
├── types/           # Domain types
├── config/          # Configuration
├── repo/            # Data access
├── service/         # Business logic
├── runtime/         # App startup
└── ui/              # API / CLI
tests/               # Mirrors backend/ structure
specs/               # Feature specs, stories, design docs
```
"""
    write_file(root / "README.md", content)


def generate_gitignore(root: Path) -> None:
    """Generate .gitignore."""
    content = """\
# Python
__pycache__/
*.py[cod]
*.egg-info/
dist/
build/
.eggs/

# Virtual environments
.venv/
venv/
env/

# IDE
.vscode/
.idea/
*.swp
*.swo

# Testing
.coverage
htmlcov/
.pytest_cache/

# Environment
.env
.env.local

# Claude Code local settings
.claude/settings.local.json

# OS
.DS_Store
Thumbs.db
"""
    write_file(root / ".gitignore", content)


def main() -> None:
    project_type = sys.argv[1] if len(sys.argv) > 1 else "python-fastapi"
    project_root = Path(sys.argv[2]) if len(sys.argv) > 2 else Path(".")
    project_root = project_root.resolve()

    print(f"Scaffolding {project_type} project at {project_root}")
    print()

    # Copy full .claude/ directory from plugin (agents, commands, skills, etc.)
    print("--- Copying forge toolkit (.claude/) ---")
    copy_plugin_directory(project_root)
    print()

    # Create project structure
    print("--- Creating project structure ---")
    create_src_structure(project_root)
    create_test_structure(project_root)
    create_spec_structure(project_root)
    print()

    # Generate config files
    print("--- Generating config files ---")
    generate_claude_md(project_root, project_type)
    generate_readme(project_root, project_type)
    generate_pyproject(project_root)
    generate_makefile(project_root)
    generate_env_example(project_root)
    generate_gitignore(project_root)

    # Create backend/__init__.py and tests/__init__.py
    write_file(project_root / "src" / "__init__.py", "")
    write_file(project_root / "tests" / "__init__.py", "")

    print()
    print("=" * 60)
    print("Project scaffolded successfully!")
    print(f"  Layers: {', '.join(SRC_LAYERS)}")
    print(f"  Spec dirs: {', '.join(SPEC_DIRS)}")
    print(f"  Forge toolkit: .claude/ (agents, commands, skills, hooks)")
    print()
    print("Next steps:")
    print(f"  cd {project_root}")
    print("  claude              # No --plugin-dir needed!")
    print("  > /build <describe your app>")
    print("=" * 60)


if __name__ == "__main__":
    main()
